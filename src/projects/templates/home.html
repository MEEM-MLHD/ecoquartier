{% extends "base.html" %}
{% load leaflet_tags bootstrap3 %}

{% block body %}

<div>
<a class="btn btn-success" href="{% url 'create' %}">Ajouter votre projet d'écoquartier</a>
</div>

<div class="row">

<div class="col-md-8">
{% leaflet_map "yourmap" %}
</div>
<div class="col-md-4">
<form action="" method="get">
	{% bootstrap_form filter.form %}
	{% buttons %}
    <button type="submit" class="btn btn-primary btn-block">
      Filtrer
    </button>
  {% endbuttons %}
</form>
</div>
</div>

<h1>{{ filter.qs|length }} projets</h1>

<ul>
{% for obj in filter %}
    <li>{{ obj }} {% if obj.commune.charte_ecoquartier %}<span class="tag tag-success">Charte Ecoquartier</span>{% else %}<span class="tag tag-warning">Pas de charte</span>{% endif %}</li>
{% endfor %}
</ul>

{% endblock %}

{% block after-body %}
{{ block.super }}
<script type="text/javascript">
  $(window).on('map:init', function (e) {
      function onEachFeature(feature, layer) {
      if (feature.properties) {
          var content_img = '';
          if(feature.properties.feature !== null){
          var content_img = "<img src='"+feature.properties.feature+"' style='width:100%' />"
          }
          var content = content_img+'<b>'+feature.properties.nom+" ("+feature.properties.commune_label+") </b><br>"+feature.properties.short_description + "<br/><br/><div> <a target='_blank' href='"+feature.properties.url+"' class='btn btn-outline-primary btn-block btn-sm' role='button'>Détail</a> </div>";

          layer.bindPopup(content);
          }
      }
      var detail = e.originalEvent ?
                   e.originalEvent.detail : e.detail;
      L.geoJson({{ geojson|safe }}, {
        onEachFeature: onEachFeature,
        pointToLayer: function(feature, latlng) {
          return new L.CircleMarker(latlng, {radius: 1, fillOpacity: 0.85});
        }
      }).addTo(detail.map);
  });
</script>
{% endblock %}
